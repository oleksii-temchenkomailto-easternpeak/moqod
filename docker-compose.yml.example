version: '3'

services:
  web:
    build:
      context: docker
      dockerfile: ./nginx/Dockerfile
    volumes:
      - ./:/var/www
      - ./docker/nginx/config/proxy.conf:/etc/nginx/conf.d/proxy.conf
#      - ./docker/nginx/config/vhost.conf:/etc/nginx/conf.d/default.conf
      - ./docker/nginx/config/xvhost.conf:/etc/nginx/conf.d/default.conf
      - ./docker/nginx/logs:/etc/logs/nginx
    depends_on:
      - xapp
      - app
    ports:
      - 8080:80

  app:
    build:
      context: docker
      dockerfile: ./php/fpm/Dockerfile
    volumes:
      - ./:/var/www
      - ./docker/php/logs:/var/log
      - ./docker/php/config/uploads.ini:/usr/local/etc/php-fpm.d/custom.ini
      - ./docker/php/config/uploads.ini:/usr/local/etc/php/conf.d/custom.ini
    depends_on:
      - postgres
      - composer
    links:
      - postgres

  xapp:
    build:
      context: docker
      dockerfile: ./php/xdebug/Dockerfile
    environment:
      XDEBUG_CONFIG: remote_host=172.19.0.1
      PHP_IDE_CONFIG: serverName=xdebug
    volumes:
      - ./:/var/www
      - ./docker/php/logs:/var/log
      - ./docker/php/config/uploads.ini:/usr/local/etc/php-fpm.d/custom.ini
      - ./docker/php/config/uploads.ini:/usr/local/etc/php/conf.d/custom.ini
    depends_on:
      - postgres
    links:
      - postgres

  postgres:
    image: postgres:9.6
    environment:
      POSTGRES_USER: maisonsport
      POSTGRES_PASSWORD: password
    volumes:
      - ./docker/postgresql/data:/var/lib/postgresql/data
      - ./docker/postgresql/dump:/dump
    ports:
      - 5433:5432

  composer:
    image: composer
#    command: composer require laravel/homestead --dev --ignore-platform-reqs
    command: composer update --ignore-platform-reqs
#    command: composer install --ignore-platform-reqs
    volumes:
      - ./:/app

  node:
    build:
      context: docker
      dockerfile: ./node/Dockerfile
    volumes:
      - ./:/usr/src/app
      - ./node_modules:/usr/src/app/node_modules
      - ./docker/node/logs:/root/.npm/_logs/
#    command: bash -c "node -v"
#    command: bash -c "npm -v"
#    command: tail -f /etc/hosts
#    command: /usr/src/app/node_modules/gulp/bin/gulp.js
    command: bash -c "npm i && /usr/src/app/node_modules/gulp/bin/gulp.js"

  watch:
    build:
      context: docker
      dockerfile: ./node/Dockerfile
    volumes:
      - ./:/usr/src/app
      - ./node_modules:/usr/src/app/node_modules
      - ./docker/node/logs:/root/.npm/_logs/
    depends_on:
      - node
    command: "npm run dev"

#  node13:
#    build:
#      context: docker
#      dockerfile: ./node13/Dockerfile
#    volumes:
#      - ./:/usr/src/app
#      - ./node_modules:/usr/src/app/node_modules
#      - ./docker/node13/logs:/root/.npm/_logs/
##    command: bash -c "node -v"
##    command: bash -c "npm -v"
#    command: tail -f /etc/hosts
##    command: /usr/src/app/node_modules/gulp/bin/gulp.js
##    command: bash -c "npm i && /usr/src/app/node_modules/gulp/bin/gulp.js"
